---
# yaml-language-server: $schema=https://kubernetes-schemas.devbu.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app authelia-com
spec:
  interval: 15m
  chart:
    spec:
      chart: authelia
      version: 0.8.54
      sourceRef:
        kind: HelmRepository
        name: authelia
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    pod:
      kind: Deployment
      replicas: 1
    domain: deangalvin.com
    secret:
      existingSecret: authelia-external
      ldap:
        key: LDAP_PASSWORD
      jwt:
        key: JWT_KEY
    ingress:
      enabled: true
      className: "${INGRESS_CLASS}"
      annotations:
        hajimari.io/icon: mdi:shield-account
      tls:
        enabled: true
        secret: deangalvin-com-production-tls
    configMap:
      access_control:
        default_policy: one_factor
        rules:
          - domain: plex.public.deangalvin.com
            policy: bypass
          - domain: hass.public.deangalvin.com
            policy: bypass
          - domain: jeffbot.public.deangalvin.com
            policy: bypass
      session:
        redis:
          host: redis-master.default
      notifier:
        filesystem:
          enabled: true
          filename: /var/file-notifier.txt
        smtp:
          enabled: false
      authentication_backend:
        ldap:
          username_attribute: uid
          display_name_attribute: givenName
          additional_users_dn: ou=people
          users_filter: (&({username_attribute}={input})(objectClass=posixAccount))
          groups_filter: (&(memberUid={username})(objectClass=posixGroup))
          group_name_attribute: cn
          additional_groups_dn: ou=users
          mail_attribute: mail
          url: ldap://glauth
          base_dn: DC=home,DC=lab
          user: CN=search_user,DC=home,DC=lab
      storage:
        postgres:
          enabled: false
        local:
          enabled: true
      telemetry:
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
