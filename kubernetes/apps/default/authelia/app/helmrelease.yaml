---
# yaml-language-server: $schema=https://kubernetes-schemas.devbu.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app authelia
  namespace: default
spec:
  interval: 15m
  chart:
    spec:
      chart: authelia
      version: 0.8.53
      sourceRef:
        kind: HelmRepository
        name: authelia
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    pod:
      kind: Deployment
      replicas: 1
    domain: deangalvin.dev
    secret:
      existingSecret: authelia-external
      ldap:
        key: LDAP_PASSWORD
      jwt:
        key: JWT_KEY
    ingress:
      enabled: true
      className: "${INGRESS_CLASS}"
      annotations:
        hajimari.io/icon: mdi:shield-account
      tls:
        enabled: true
        secret: "${PRODUCTION_TLS}"
    configMap:
      log:
        level: trace
      storage:
        postgres:
          enabled: false
        local:
          enabled: true
      access_control:
        default_policy: one_factor
        rules: []
      session:
        redis:
          host: redis-master
      notifier:
        filesystem:
          enabled: true
          filename: /var/file-notifier.txt
        smtp:
          enabled: false
      authentication_backend:
        ldap:
          username_attribute: uid
          display_name_attribute: givenName
          additional_users_dn: ou=users
          users_filter: (&({username_attribute}={input})(objectClass=posixAccount))
          groups_filter: (&(memberUid={input})(objectClass=posixGroup))
          group_name_attribute: cn
          mail_attribute: mail
          url: ldap://glauth
          base_dn: DC=home,DC=lab
          user: CN=search_user,DC=home,DC=lab
      identity_providers:
        oidc:
          enabled: true
          cors:
            endpoints: ["authorization", "token", "revocation", "introspection"]
            allowed_origins_from_client_redirect_uris: true
          clients:
            - id: gitops
              description: Weave Gitops
              secret: '$plaintext$gitops_client_secret'
              public: false
              authorization_policy: one_factor
              redirect_uris:
                - https://gitops.deangalvin.dev/oauth2/callback
              scopes:
                - offline_access
                - openid
                - profile
                - groups
                - email
              userinfo_signing_algorithm: none
            - id: proxmox
              description: Proxmox
              secret: '$plaintext$proxmox_client_secret'
              public: false
              authorization_policy: one_factor
              redirect_uris:
                - https://proxmox.deangalvin.dev
              scopes:
                - openid
                - profile
                - email
              userinfo_signing_algorithm: none
      telemetry:
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
