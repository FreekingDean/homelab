---
{{- include "bjw-s.common.loader.init" . }}

{{- define "app-template.hardcodedValues" -}}
# Set the nameOverride based on the release name if no override has been set
{{ if not .Values.global.nameOverride }}
global:
  nameOverride: "{{ .Release.Name }}"
controllers:
  {{ .Release.Name }}:
    replicas: {{ .Values.replicas }}
    containers:
      {{ .Release.Name }}:
        image:
          repository: {{ .Values.image.repository }}
          tag: {{ .Values.image.tag }}
        command: {{ .Values.command }}
service:
  app:
    controller: {{ .Release.Name }}
    ports:
    {{- range $name, $port := .Values.ports}}
      {{ $name }}:
        port: {{ $port }}
    {{- end }}
serviceMonitor:
  app:
    controller: {{ .Release.Name }}
    enabled: true
    endpoints:
      - port: {{ .Values.serviceMonitor.port }}
        scheme: http
        path: {{ .Values.serviceMonitor.path }}
        interval: 1m
        scrapeTimeout: 10s
persistence:
  {{- range $name, $config := .Values.persistence.secrets }}
    {{ $name }}:
      enabled: true
      type: secret
      name: {{ $config.name }}
      items:
      {{- range $key := $config.items }}
        - key: {{ $key }}
          path: {{ $path }}
      {{- end }}
  {{- end }}
{{ end }}
{{- end -}}
{{- $_ := mergeOverwrite .Values (include "app-template.hardcodedValues" . | fromYaml) -}}

{{/* Render the templates */}}
{{ include "bjw-s.common.loader.generate" . }}
