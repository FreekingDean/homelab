---
{{- include "bjw-s.common.loader.init" . }}

{{- define "app-template.hardcodedValues" -}}
# Set the nameOverride based on the release name if no override has been set
{{ if not .Values.global.nameOverride }}
global:
  nameOverride: "{{ .Release.Name }}"
{{ end }}

defaultPodOptions:
{{ if .Values.resources }}
  resources:
    requests:
      memory: {{ .Values.resources.requests }}
    limits:
      memory: {{ .Values.resources.limits }}
{{ end }}
{{ if .Values.labels }}
  labels:
    app: {{{
    version: v1
  podSecurityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    fsGroupChangePolicy: "OnRootMismatch"
controllers:
  main:
    replicas: 2
    strategy: RollingUpdate
    annotations:
      reloader.stakater.com/auto: "true"
    containers:
      main:
        image:
          # https://github.com/glauth/glauth/issues/298
          repository: ghcr.io/onedr0p/glauth
          tag: v2.2.0-rc1
        command: ["/app/glauth", "-c", "/config"]
service:
  main:
    ports:
      http:
        port: 5555
      ldap:
        enabled: true
        port: 389
serviceMonitor:
  main:
    enabled: true
    endpoints:
      - port: metrics
        scheme: http
        path: /metrics
        interval: 1m
        scrapeTimeout: 10s
persistence:
  config:
    enabled: true
    type: secret
    name: glauth-secret
    items:
      - key: server.toml
        path: server.toml
      - key: groups.toml
        path: groups.toml
      - key: users.toml
        path: users.toml
{{- end -}}
{{- $_ := mergeOverwrite .Values (include "app-template.hardcodedValues" . | fromYaml) -}}

{{/* Render the templates */}}
{{ include "bjw-s.common.loader.generate" . }}

