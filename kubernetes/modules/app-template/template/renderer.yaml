---
{{- include "bjw-s.common.loader.init" . }}

{{- define "app-template.hardcodedValues" -}}
# Set the nameOverride based on the release name if no override has been set
{{ if not .Values.global.nameOverride }}
global:
  nameOverride: "{{ .Release.Name }}"
{{ end }}

defaultPodOptions:
{{ if .Values.resources }}
  resources:
    requests:
      memory: {{ .Values.resources.requests }}
    limits:
      memory: {{ .Values.resources.limits }}
{{ end }}
{{ with .Values.pod.labels}}
  labels:
    {{- toYaml . | nindent 4 }}
{{ end }}
{{ if .Values.runAsUser }}
  podSecurityContext:
    runAsUser: {{ .Values.runAsUser }}
    runAsGroup: {{ .Values.runAsUser }}
    fsGroup: {{ .Values.runAsUser }}
    fsGroupChangePolicy: "OnRootMismatch"
{{ end }}
controllers:
  main:
    replicas: {{ .Values.replicas }}
    strategy: RollingUpdate
    annotations:
      {{ with .Values.annotations }}
      {{- toYaml . | nindent 6 }}
      {{ end }}
      reloader.stakater.com/auto: "true"
    {{ if .values.labels }}
    labels:
      {{ with .Values.labels }}
      {{- toYaml . | nindent 6 }}
      {{ end }}
    {{ end }}
    containers:
      main:
        image:
          # https://github.com/glauth/glauth/issues/298
          repository: {{ .Values.image.repository }}
          tag: {{ .Values.image.tag }}
        command: {{ .Values.command }}

{{ if .Values.ports }}
service:
  main:
    ports:
      {{ range $name, $port := .Values.ports }}
      {{ $name }}:
        enabled: true
        port: {{ $port }}
{{ end }}

{{ if .Values.serviceMonitor }}
serviceMonitor:
  main:
    enabled: true
    endpoints:
      - port: metrics
        scheme: http
        path: /metrics
        interval: 1m
        scrapeTimeout: 10s
{{ end }}

{{ if .Values.persistence }}
persistence:
  {{ range $name, $config := persistence }}
    {{ $name }}:
      enabled: true
      type: {{ $config.type }}
      {{ if eq $config.type "secret" }}
      name: {{ $config.name }}
      {{ if $config.items }}
      items:
        {{ range $key, $path := $config.items }}
        - key: {{ $key }}
          path: {{ $path }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}
{{- end -}}

{{- $_ := mergeOverwrite .Values (include "app-template.hardcodedValues" . | fromYaml) -}}

{{/* Render the templates */}}
{{ include "bjw-s.common.loader.generate" . }}

